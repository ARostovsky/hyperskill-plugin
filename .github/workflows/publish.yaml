name: Publish to JetBrains Marketplace

on:
  push:

concurrency:
  group: publish-plugin-${{ github.ref_name }}
  cancel-in-progress: true


jobs:
  test:
    name: Run Tests for ${{ matrix.environmentName }}
    runs-on: arc-runners-small
    timeout-minutes: 60
    strategy:
      matrix:
        environmentName:
          - 251
          - 252
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: actions/setup-java@v4
        with:
          java-version-file: '.java-version'
          distribution: 'corretto'
          cache: 'gradle'

      - name: Run Tests
        env:
          GRADLE_OPTS: "-Xmx2g -XX:MaxMetaspaceSize=512m -Dkotlin.daemon.jvm.options=-Xmx1g"
        run: |
          echo "environmentName=${{ matrix.environmentName }}"
          ./gradlew test \
            --parallel -Dorg.gradle.workers.max=2 -Dorg.gradle.test.worker.max=2 \
            --no-daemon -PenvironmentName=${{ matrix.environmentName }}

  verify:
    name: Verify Plugin for ${{ matrix.environmentName }}
    runs-on: arc-runners-small
    timeout-minutes: 60
    strategy:
      matrix:
        environmentName:
          - 251
          - 252
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: actions/setup-java@v4
        with:
          java-version-file: '.java-version'
          distribution: 'corretto'
          cache: 'gradle'

      - name: Verify Plugin
        env:
          GRADLE_OPTS: "-Xmx2g -XX:MaxMetaspaceSize=512m -Dkotlin.daemon.jvm.options=-Xmx1g"
        run: |
          echo "environmentName=${{ matrix.environmentName }}"
          ./gradlew verifyPlugin \
            --parallel -Dorg.gradle.workers.max=2 -Dorg.gradle.test.worker.max=2 \
            --no-daemon -PenvironmentName=${{ matrix.environmentName }}

#  publish:
#    name: Publish Plugin
#    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
#    runs-on: arc-runners-small
#    needs:
#      - test
#      - verify
#    timeout-minutes: 30
#    steps:
#      - uses: actions/checkout@v4
#
#      - uses: actions/setup-java@v4
#        with:
#          java-version-file: '.java-version'
#          distribution: 'corretto'
#
#      - name: Publish Plugin
#        run: |
#          ./gradlew publishPlugin --no-daemon
#        env:
#          JB_MARKETPLACE_TOKEN: ${{ secrets.JB_MARKETPLACE_TOKEN }}
